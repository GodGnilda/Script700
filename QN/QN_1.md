# 新・熱血硬派くにおたちの挽歌のサウンドドライバ で ROM のデータを使用して音楽を演奏するスクリプト

## 概要
[改良版 SNESAPU.DLL](https://github.com/dgrfactory/spcplay) (v2.19.0 以降) で動作するスクリプトファイルです。  
サウンドドライバファンクションを利用して、音楽データや圧縮波形データを APU RAM に転送し音楽を演奏します。

### 準備
- 新・熱血硬派くにおたちの挽歌のサウンドドライバが転送された状態の SPC ファイルが必要です。
- 以下のファイルを作成する必要があります。スクリプトのファイル名等は適宜変更してください。
  - **QN_SONG.BIN**  
音楽データファイルです。  
[新・熱血硬派くにおたちの挽歌 音楽シーケンスデータ生成ツール](https://gnilda.rosx.net/SPC/QN/spcseq.html) で **SPC ファイルを選択しない (テキスト出力)** にチェックを入れ、出力されたテキストをヘキサエディタに貼り付けて保存します。
  - **BRR32.BIN**, **BRR33.BIN**, ...  
圧縮波形に関するファイルです。  
ラベル番号 *1000* の波形データは波形番号 *32* に、*1001* の波形データは *33* に登録されます。  
一つのラベルに複数のファイルを読み込む設定の場合はアドレス計算が不可能なため、先頭のファイルのみ登録されます。  
ファイルの構造は以下の通りです。

  |オフセット|データ|サイズ|
  |--:|:--|:--|
  |0|データサイズ (LE)|2 バイト|
  |2|ループポイントの位置 (LE)|2 バイト|
  |4|圧縮波形データ|9n バイト|
- スクリプト書き換え  
13 行の即値を**転送する圧縮波形データの数 + 1000** に書き換えます。

### 使用方法
- [SNES SPC700 Player](https://github.com/dgrfactory/spcplay)
  - SPC とスクリプトのファイル名が同じ場合は、SPC ファイルを開きます。  
  スクリプトファイルが自動的に読み込まれ、指定した曲のテータを転送し演奏開始します。
  - SPC とスクリプトのファイル名が異なりスクリプトファイルが自動的に読み込まれない場合は、SPC ファイルを開いた後にスクリプトファイルをドラッグ & ドロップします。  
  スクリプトファイルが読み込まれ、指定した曲のテータを転送し演奏開始します。
- [黒猫SPC](https://kurohane.net/seisanbutu.html)
  - 演奏設定 SNESAPU タブの NoScript700 のチェックをオフにし、スクリプトを有効にします。
  - SPC とスクリプトのファイル名を同じにして、SPC ファイルを開きます。  
  スクリプトファイルが自動的に読み込まれ、指定した曲のテータを転送し演奏開始します。

### 演奏開始直前のスナップショット保存
ブレークポイントを利用可能なプレイヤーのみ保存可能です。
- [SNES SPC700 Player](https://github.com/dgrfactory/spcplay)  
134 行の `bp` コマンドを有効にし、SPC 700 の PC レジスタの値が $0348 で停止している状態であることを確認後に SPC ファイルを保存してください。

### 既知の不具合
- 演奏開始直後の音が短くなる  
本体側の処理とスクリプトの処理が異なると考えられます。 131 - 132 行で次のコマンドを実行するまで待機する回数を *1* → *2* に変更し、不具合を解消しています。

### ライセンス
[MITライセンス](https://opensource.org/licenses/mit-license.php)

### 更新履歴
- 2021/10/10
  - 試作。
***
## 他の MINT サウンドドライバで動作するように改造するには ?
[VGMTrans](https://github.com/vgmtrans/vgmtrans) や [SNES SPC700 Player](https://github.com/dgrfactory/spcplay) でアドレスを確認して上書きします。
- 音楽データファイル
  - 先頭 2 バイトの値 ($1300) を `VGMTrans` の **Instrument Set の先頭アドレス**に書き換える。
- スクリプト
  - 28 行
    - `VGMTrans` で **Sequence の先頭アドレス**を確認し、ヘキサエディタでその値を検索する。
    - 即値 (#$1200) をヒットした APU RAM アドレスに書き換える。
  - 47 行
    - 即値 (#$1300) を `VGMTrans` の **Instrument Set の先頭アドレス**に書き換える。
  - 69 - 83 行
    - 新・熱血硬派くにおたちの挽歌で未使用と思われる領域に書き込むので無効にする。
  - 112 行
    - `SNES SPC700 Player` で **SrcAddr** を確認し、即値 (#$1180) を常駐ではない波形の先頭アドレスに書き換える。
  - 131 - 132 行
    - 無効にする。不具合が発生する場合は気合で探してアドレスを書き換える。
  - サウンドドライバファンクションが期待した動作ではない。
    - $80 ～ $9F まで試してみる。動かない場合は気合で修正。
