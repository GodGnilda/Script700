# FINAL FANTASY IV 改造サウンドドライバ で音楽と圧縮波形のデータファイルを使用して音楽を演奏するスクリプト

## 概要
[改良版 SNESAPU.DLL](https://github.com/dgrfactory/spcplay) (v2.19.0 以降) で動作するスクリプトファイルです。  
サウンドドライバファンクションを利用して、ROM の音楽データや圧縮波形データ等を APU RAM に転送し音楽を演奏します。  
ROM に登録されている (波形番号) 順に圧縮波形データを転送します。

## ファイル
- [FINAL FANTASY IV の改造サウンドドライバ](https://github.com/GodGnilda/F4G-0) が転送された状態の SPC ファイルが必要です。  
スナップショットを保存せずそのまま演奏する場合は、ジングル類を演奏終了状態の SPC をお使いになることで、ノイズ発生を抑制することが可能です。
- 以下のファイルを作成する必要があります。スクリプトのファイル名等は適宜変更してください。
  - **SONG.BIN**  
音楽データファイルです。  
[FINAL FANTASY IV 改造サウンドドライバ : 音楽シーケンスデータ生成ツール](https://gnilda.rosx.net/SPC/F4G/spcseq.html) で <del>**SPC ファイルを選択しない (テキスト出力)** にチェックを入れ、</del>出力されたテキストをヘキサエディタに貼り付けて保存します。
  - **BRR09.BIN**, **BRR10.BIN**, ...  
圧縮波形に関するファイルです。  
ラベル番号 *0* の波形データは波形番号 *9* に、*1* の波形データは *10* に登録されます。  
一つのラベルに複数のファイルを読み込む設定の場合はアドレス計算が不可能なため、先頭のファイルのみ登録されます。  
ファイルの構造は以下の通りです。

  |オフセット|データ|サイズ|
  |--:|:--|:--|
  |0|データサイズ (LE)|2 バイト|
  |2|ループポイントの位置 (LE)|2 バイト|
  |4|圧縮波形データ|9n バイト|
- スクリプト書き換え  
  - 18 行の即値を**転送する圧縮波形データの数**に書き換えます。  
  - ラベル番号 *25* の 25 バイトのデータを書き換えることで、データ転送時の圧縮波形番号 9 ～ 33 のピッチ微調整値 1 を変更可能です。

## プレイヤーの設定など
- [SNES SPC700 Player](https://github.com/dgrfactory/spcplay)
  - SNES SPC700 Player を起動し、バージョンを確認します。  
  v2.19.0 以降のバージョンではない場合は https://github.com/dgrfactory/spcplay/releases から spcplay-x.xx.x.xxxx.zip (v2.19 以降) をダウンロードし SNES SPC700 Player を更新します。
- [黒猫SPC](https://kurohane.net/seisanbutu.html)
  - 演奏設定ウィンドウ 黒猫 タブで、**使用する SNESAPU** を **Sunburst** に設定します。
  - メインウィンドウで [改良版 SNESAPU.DLL](https://github.com/dgrfactory/spcplay) のバージョンを確認します。  
  v2.19.0 以降のバージョンではない場合は 黒猫SPC を終了し、 https://github.com/dgrfactory/spcplay/releases から snesapu-x.xx.x.xxxx.zip (v2.19 以降) をダウンロードし、黒猫SPC の SNESAPU Sunburst フォルダの DLL を上書きします。
  - 演奏設定ウィンドウ SNESAPU タブの **NoScript700** のチェックを**オフ**にし、スクリプトを有効にします。

## 使用方法
- [SNES SPC700 Player](https://github.com/dgrfactory/spcplay)
  - SPC とスクリプトのファイル名が同じ場合は、SPC ファイルを開きます。  
  スクリプトファイルが自動的に読み込まれ、指定した曲のテータを転送し演奏開始します。
  - SPC とスクリプトのファイル名が異なりスクリプトファイルが自動的に読み込まれない場合は、SPC ファイルを開いた後にスクリプトファイルをドラッグ & ドロップします。  
  スクリプトファイルが更新され、指定した曲のテータを転送し演奏開始します。演奏状態は初期化されます。
  - ブレークポイントコマンド `bp` を使用したスナップショット保存をご利用になれます。
- [黒猫SPC](https://kurohane.net/seisanbutu.html)
  - SPC とスクリプトのファイル名を同じにして、SPC ファイルを開きます。  
  スクリプトファイルが自動的に読み込まれ、指定した曲のテータを転送し演奏開始します。
  - ブレークポイントコマンド `bp` を使用したスナップショット保存はご利用になれません。

## 演奏開始直前のスナップショット保存
ブレークポイントを利用可能なプレイヤーのみ保存可能です。
- [SNES SPC700 Player](https://github.com/dgrfactory/spcplay)  
198 行の `bp` コマンドを有効にし、SPC 700 の PC レジスタの値が $0544 で停止している状態であることを確認後に SPC ファイルを保存してください。  
保存するタイミング次第では DSP のキーオンフラグがクリアされずにノイズが発生する場合がございます。この不具合は SPC ファイルの $1014C を $00 に書き換えることで解消可能です。

## ライセンス
[MITライセンス](https://opensource.org/licenses/mit-license.php)

## 更新履歴
- 2021/11/22 [F4G-0 20211122-0]
  - 試作。
