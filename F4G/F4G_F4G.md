# FINAL FANTASY IV 改造サウンドドライバ で ROM のデータを使用して音楽を演奏するスクリプト

## 概要
[改良版 SNESAPU.DLL](https://github.com/dgrfactory/spcplay) (v2.19.0 以降) で動作するスクリプトファイルです。  
サウンドドライバファンクションを利用して、ROM の音楽データや圧縮波形データ等を APU RAM に転送し音楽を演奏します。  
ROM に登録されている (波形番号) 順に圧縮波形データを転送します。

## ファイル
- FINAL FANTASY IV の改造サウンドドライバが転送された状態の SPC ファイルが必要です。  
スナップショットを保存せずそのまま演奏する場合は、ジングル類を演奏終了状態の SPC をお使いになることで、ノイズ発生を抑制することが可能です。
- スクリプトが使用可能なメモリの量が制限されていますので、以下のファイルを作成する必要があります。スクリプトのファイル名等は適宜変更してください。
  - **F4_BRRS_2400F_3721C.BIN**  
sfc ファイル $2400F - $3721C のデータ (圧縮波形データ)
  - **F4G_SONGS_3721D_438B8.BIN**  
sfc ファイル $3721D - $438B8 のデータ (音楽データ)

## プレイヤーの設定など
- [SNES SPC700 Player](https://github.com/dgrfactory/spcplay)
  - SNES SPC700 Player を起動し、バージョンを確認します。  
  v2.19.0 以降のバージョンではない場合は https://github.com/dgrfactory/spcplay/releases から spcplay-x.xx.x.xxxx.zip (v2.19 以降) をダウンロードし SNES SPC700 Player を更新します。
- [黒猫SPC](https://kurohane.net/seisanbutu.html)
  - 演奏設定ウィンドウ 黒猫 タブで、**使用する SNESAPU** を **Sunburst** に設定します。
  - メインウィンドウで [改良版 SNESAPU.DLL](https://github.com/dgrfactory/spcplay) のバージョンを確認します。  
  v2.19.0 以降のバージョンではない場合は 黒猫SPC を終了し、 https://github.com/dgrfactory/spcplay/releases から snesapu-x.xx.x.xxxx.zip (v2.19 以降) をダウンロードし、黒猫SPC の SNESAPU Sunburst フォルダの DLL を上書きします。
  - 演奏設定ウィンドウ SNESAPU タブの **NoScript700** のチェックを**オフ**にし、スクリプトを有効にします。

## 使用方法
- [SNES SPC700 Player](https://github.com/dgrfactory/spcplay)
  - SPC とスクリプトのファイル名が同じ場合は、SPC ファイルを開きます。  
  スクリプトファイルが自動的に読み込まれ、指定した曲のテータを転送し演奏開始します。
  - SPC とスクリプトのファイル名が異なりスクリプトファイルが自動的に読み込まれない場合は、SPC ファイルを開いた後にスクリプトファイルをドラッグ & ドロップします。  
  スクリプトファイルが更新され、指定した曲のテータを転送し演奏開始します。演奏状態は初期化されます。
  - ブレークポイントコマンド `bp` を使用したスナップショット保存をご利用になれます。
- [黒猫SPC](https://kurohane.net/seisanbutu.html)
  - SPC とスクリプトのファイル名を同じにして、SPC ファイルを開きます。  
  スクリプトファイルが自動的に読み込まれ、指定した曲のテータを転送し演奏開始します。
  - ブレークポイントコマンド `bp` を使用したスナップショット保存はご利用になれません。

## 演奏開始直前のスナップショット保存
ブレークポイントを利用可能なプレイヤーのみ保存可能です。
- [SNES SPC700 Player](https://github.com/dgrfactory/spcplay)  
240 行の `bp` コマンドを有効にし、SPC 700 の PC レジスタの値が $0544 で停止している状態であることを確認後に SPC ファイルを保存してください。  
保存するタイミング次第では DSP のキーオンフラグがクリアされずにノイズが発生する場合がございます。この不具合は SPC ファイルの $1014C を $00 に書き換えることで解消可能です。

## 曲を変更する
17 行の即値を書き換えてください。

  |値|曲名|
  |--:|:--|
  |$01|オープニング|
  |$04|チョコボ|
  |$08|勝利のファンファーレ|
  |$09|街のテーマ|
  |$0D|ファイナルファンタジー IV メインテーマ|
  |$13|愛のテーマ|
  |$14|バロン王国|
  |$15|プレリュード|
  |$26|踊り子|
  |$27|バトル 1|
  |$2B|チョコボの森|
  |$2C|赤い翼 (ニューゲーム)|
  |$2D|疑惑のテーマ|
  |$31|もう一つの月|
  |$33|ミシディア国|

## ライセンス
[MITライセンス](https://opensource.org/licenses/mit-license.php)

## 更新履歴
- 2021/11/22 [F4G-0 20211122-0]
  - 無意味なコマンドを削除。
  - ブレークポイントのアドレスを更新。

- 2021/10/20 [F4G-0 20211020-0]
  - ブレークポイントのアドレスを更新。

- 2021/10/13 [F4G-0 20211001-0]
  - 転送する圧縮波形データが一つの場合無限ループに陥る不具合を修正。

- 2021/10/01 [F4G-0 20211001-0]
  - 試作。
